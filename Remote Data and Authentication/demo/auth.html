<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Authentication Demo</title>
    <style>
        label{
            display: block;
        }
    </style>
</head>
<body>
<h2>Register</h2>
<form id="register-form">
    <label>Email: <input type="text" name="email"/></label>
    <label>Password: <input type="password" name="password"/></label>
    <label>Repeat: <input type="password" name="repass"/></label>
    <input type="submit" value="Register"/>
</form>

<h2>Login</h2>
<form id="login-form">
    <label>Email: <input type="text" name="email"/></label>
    <label>Password: <input type="password" name="password"/></label>
    <input type="submit" value="Register"/>
</form>

<script>
    const registerForm = document.getElementById('register-form');
    registerForm.addEventListener('submit', onRegister);

    async function onRegister(e){
        e.preventDefault();

        const url = 'http://localhost:3030/users/register';
        const formData = new FormData(registerForm);

        const email = formData.get('email').trim();
        const password = formData.get('password').trim();
        const repass = formData.get('repass').trim();


        const res = await fetch(url, {
            method: 'post',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({email, password})
        });
        const result = await res.json();

        const token = result.accessToken;
        sessionStorage.setItem('token', token);

        window.location = 'index.html';
    }

    const loginForm = document.getElementById('login-form');
    loginForm.addEventListener('submit', onLogin);

    async function onLogin(e){
        e.preventDefault();

        const url = 'http://localhost:3030/users/login';
        const formData = new FormData(loginForm);

        const email = formData.get('email').trim();
        const password = formData.get('password').trim();

        try{
            const res = await fetch(url, {
                method: 'post',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({email, password})
            });

            if(res.status !== 200){
                const error = await res.json();
                throw new Error(`Error: ${error.message}`)
            }
            const result = await res.json();

            const token = result.accessToken;
            sessionStorage.setItem('token', token);

            window.location = 'index.html';
        }catch (err){
            alert(err.message);
        }


    }

</script>

</body>
</html>